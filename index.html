<!DOCTYPE html>
<html lang="en">

<head>
    <!-- CRITICAL: Theme detection MUST run FIRST - blocks initial paint -->
    <script>
        (function () {
            // Read theme BEFORE any rendering happens
            const stored = localStorage.getItem('coolest-todo-user-preferences');
            let theme = 'light';

            if (stored) {
                try {
                    const preferencesString = JSON.parse(stored);
                    const preferences = JSON.parse(preferencesString);
                    theme = preferences.theme || 'light';

                    if (theme === 'system') {
                        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    }
                } catch (e) {
                    theme = 'light';
                }
            }

            // Apply theme to html element IMMEDIATELY
            const root = document.documentElement;
            const isDark = theme === 'dark';

            if (isDark) {
                root.classList.add('dark');
            }

            root.classList.add('no-transitions');

            // Set colors with highest priority
            const bgColor = isDark ? '#111827' : '#f9fafb';
            const textColor = isDark ? '#f9fafb' : '#111827';

            root.style.cssText = `background-color:${bgColor}!important;color:${textColor}!important;`;
        })();
    </script>

    <!-- CRITICAL: Inline styles applied IMMEDIATELY after script -->
    <style>
        /* Prevent any white flash - apply colors before CSS loads */
        html {
            background-color: #f9fafb;
            color: #111827;
        }

        html.dark {
            background-color: #111827;
            color: #f9fafb;
        }

        body,
        #app {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-color: inherit;
            color: inherit;
        }

        /* Disable all transitions during initial load */
        html.no-transitions,
        html.no-transitions *,
        html.no-transitions *::before,
        html.no-transitions *::after {
            transition: none !important;
            animation: none !important;
        }

        /* KEY FIX: Ensure all elements inherit background during load to prevent white flash */
        html.no-transitions * {
            background-color: inherit !important;
        }

        /* Allow form controls to be transparent */
        html.no-transitions button,
        html.no-transitions input,
        html.no-transitions textarea,
        html.no-transitions select {
            background-color: transparent !important;
        }
    </style>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="dark light">

    <!-- Performance: Preconnect to Supabase API to reduce latency -->
    <link rel="preconnect" href="https://maxthkjjjxjqzvlaqlbq.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="https://maxthkjjjxjqzvlaqlbq.supabase.co">

    <!-- Performance: Font Loading Optimization -->
    <!-- Hint browsers to prepare system fonts early to reduce CLS from font swaps -->
    <link rel="preload" as="style" href="/src/styles/index.css">
    <style>
        /* Critical font stack - ensure system fonts render immediately with font-display: swap */
        /* This prevents the 342ms layout shift observed during font loading */
        html,
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* Optimize font rendering to minimize layout shifts */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            /* Prevent font metric changes from causing layout shifts */
            font-feature-settings: normal;
            font-variant-ligatures: normal;
        }
    </style>

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline'; 
                   style-src 'self' 'unsafe-inline'; 
                   img-src 'self' data:; 
                   font-src 'self' data:; 
                   connect-src 'self' https://*.supabase.co; 
                   base-uri 'self'; 
                   form-action 'self'; 
                   upgrade-insecure-requests;" />

    <meta name="description"
        content="✨ The Coolest Todo App (ever) - A modern, feature-rich task management app with smart due dates, categories, and beautiful themes. Get things done with style!" />
    <meta name="keywords" content="todo, task manager, productivity, preact, vite, tailwind" />
    <meta name="author" content="Coolest Todo App Team" />
    <meta name="theme-color" content="#3b82f6" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="✨ The Coolest Todo App (ever)" />
    <meta property="og:description"
        content="Get things done with style! Modern todo app with smart features and beautiful themes." />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="✨ The Coolest Todo App (ever)" />
    <meta name="twitter:description"
        content="Get things done with style! Modern todo app with smart features and beautiful themes." />

    <!-- Favicon and Manifest -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="manifest" href="/site.webmanifest">

    <title>✨ The Coolest Todo App (ever) - Get Things Done with Style</title>
</head>

<body>
    <div id="app"></div>
    <script type="module" src="/src/main.jsx"></script>

    <noscript>
        <div style="text-align: center; padding: 2rem; font-family: system-ui;">
            <h1>✨ Coolest Todo App</h1>
            <p>Please enable JavaScript to use this application.</p>
        </div>
    </noscript>
</body>

</html>